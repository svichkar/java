tdefine('/tbone-2.0.0.min.js',['require','exports','module','/js/3/lodash.js'],function(require,exports,module){
"use strict";!function(e){function t(){return void 0}function n(e){return null!==e&&"object"==typeof e&&!N(e)}function r(e){return!(!e||"function"!=typeof e.query)}function i(e){for(var t,n,r,i=[],o=[e._events];t=o.pop();)for(r in t)if(""===r){n=t[""];for(var a in n)i.push(n[a])}else o.push(t[r]);return _.uniq(i)}function o(e){for(var t,n=[e],r=[e];t=n.pop();)for(var o=i(t),a=0;a<o.length;a++){for(var u=o[a];u&&!u.isView&&!u.isModel;)u=u.parentScope||u.context;if(u){if(u.isView)return!0;u.isModel&&-1===r.indexOf(u)&&(n.push(u),r.push(u))}}return!1}function a(e,t,i,o,u,s,c){if(s>R)return!0;t=t||U,i=i,o=o;var l,f=c,d=u;o!==i&&(r(o)||r(i)?(f=!0,c=!0):n(o)&&n(i)?d=!0:N(o)&&N(i)?o.getTime()!==i.getTime()&&(f=!0):f=!0);for(l in t)l!==M&&a(e,t[l],i&&i[l],o&&o[l],!1,s+1,c)&&(f=!0);if(d&&!f&&n(o)&&n(i))if(o.length!==i.length)f=!0;else{for(l in i)if(a(e,t[l],i[l],o[l],!0,s+1,!1)){f=!0;break}if(!f)for(l in o)if(void 0===i[l]){f=!0;break}}if(f){var p=t[M]||U;for(var h in p)p[h].trigger()}return f}function u(){var e=this,t=arguments,i=t[0],o=t[1],u=t[2],s=3===t.length;if("object"!=typeof i&&(u=o,o=i,i=U,2===t.length&&(s=!0)),!o&&i.dontGetData)return e;for(var l,f,p=c(o),h=[],v=[],y=e.attributes,m={},b=s&&e._events;;){if(r(y)){f=p&&p.length||!(s&&r(u));break}if(l=p.shift(),!l)break;s&&!n(y)&&(y=T.exec(l)?[]:{},e.query(v.join("."),y)),v.push(l),h.push(y),y=null!=y?y[l]:void 0,b&&(_.extend(m,b[M]||U),b=b[l])}if(!s&&I){var g=d(e);I[g]||(I[g]={obj:e,props:{}}),I[g].props[v.join(".")]=y}if(f)return s?y.query(i,p.join("."),u):y.query(i,p.join("."));if(s){h.length?h[h.length-1][v[v.length-1]]=u:e.attributes=u;var x=!_.isEmpty(m);return a(e,b,y,u,x,0,i.assumeChanged)&&_.each(m,function(e){e.trigger()}),u}return y}function s(e){return _.isArray(e)?e:[]}function c(e){var t=e?e.replace("__self__",""):"";return t?t.split("."):[]}function l(){return(new Date).getTime()}function f(e){"function"==typeof e&&(e={fn:e});var t=e.context,n=_.extend({},Q,{priority:V?V.priority-1:S,Name:e.fn.name},e,{fn:e.fn.bind(t),subScopes:[],lookups:null});return t&&t.onScopeExecute&&(n.onExecuteCb=t.onScopeExecute.bind(t,n)),!n.detached&&V&&(V.subScopes.push(n),n.parentScope=V),n.deferExec?n.trigger():n.execute(),n}function d(e){return e.tboneid||(e.tboneid=L++),e.tboneid}function p(){return P&&($.sort(function(e,t){return e.priority-t.priority}),P=!1),$.pop()}function h(e){var t=e.tboneid;H[t]||(H[t]=e,W.increment("ajax.numReqStarted"),y())}function v(e){var t=e.tboneid;H[t]&&(delete H[t],W.increment("ajax.numReqFinished"),y())}function y(){K||(K=setTimeout(function(){var e=_.keys(H).length;W.query("isReady",_.isEmpty(H)&&!J),W.query("ajax.modelsInFlight",_.clone(H)),W.query("ajax.isReady",0===e),W.query("ajax.numInFlight",e),K=null},0))}function m(e){var t=d(e);B[t]||(B[t]=!0,$.push(e),P=!0,J||(y(),J=_.defer(b)))}function b(){if(J=null,$.length){var e;l(),J=_.defer(b);for(var t=5e3;--t&&(e=p());)delete B[d(e)],e.execute();y()}}function g(t){return function(n){e.history[t+"State"](U,"",n),x(e).trigger(t+"state")}}var _=e._||require("/js/3/lodash.js"),x=e.$,q=1e4,S=4e3,k=3e3,j=2e3,C=1e3,E={highest:q,bound:k,beforeViews:j+500,view:j,afterViews:j-500,async:C,lowest:0},N=_.isDate,w=_.isFunction,U={};Object.freeze(U);var D,T=/^\d+$/,M="",R=16,z={isModel:!0,make:function(e){var t=this,n=function(e,t){var i=typeof e;return"function"===i||"object"===i?f(e):"function"!=typeof t||r(t)?0===arguments.length?n.query():1===arguments.length?n.query(e):n.query(e,t):n.query(e,n.bound(t))};return _.extend(n,t,w(e)?{state:e,Name:e.name}:e||U),n.tboneid=void 0,n.attributes=void 0,n._events={},n._removeCallbacks={},d(n),n.initialize(),n},extend:function(e){return _.extend({},this,e)},initialize:t,on:function(e,t){for(var n,r=c(e),i=this._events;null!=(n=r.shift());)i[n]||(i[n]={}),i=i[n];var o=i[""];o||(o=i[""]={});var a=d(t);o[a]=t,this.wake({})},off:function(e,t){for(var n,r=c(e),i=this._events;null!=(n=r.shift());)i[n]||(i[n]={}),i=i[n];var o=i[""];if(o){var a=d(t);delete o[a]}},trigger:function(e){for(var t,n=this,r=n._events,i=c(e);null!=(t=i.shift());)r[t]||(r[t]={}),r=r[t];var o=r[M]||U;for(var a in o)o[a].trigger()},runOnlyOnce:function(e){f(e).destroy()},query:u,queryModel:function(e){return this.query({dontGetData:!0},e)},readSilent:function(e){var t=I;I=null;var n=this.query(e);return I=t,n},idAttribute:"id",queryId:function(){return this.query(this.idAttribute)},bound:function(e){return D.make(e)},getName:function(e){if(e||(e=this),e.Name)return e.Name;var t=e.context||e.parentScope;return t?this.getName(t)+"+":"na-"+e.tboneid},toggle:function(e){this.query(e,!this.readSilent(e))},push:function(e,t){return 1===arguments.length&&(t=e,e=""),this.query(e,s(this.readSilent(e)).concat([t]))},unshift:function(e,t){return 1===arguments.length&&(t=e,e=""),this.query(e,[t].concat(s(this.readSilent(e))))},removeFirst:function(e){return this.query(e,s(this.readSilent(e)).slice(1))},removeLast:function(e){return this.query(e,s(this.readSilent(e)).slice(0,-1))},unset:function(e){if(e){var t=e.split("."),n=t.pop(),r=t.join(".");this.query(r,_.omit(this.readSilent(r),n))}else this.query("",void 0)},increment:function(e,t){var n=this.readSilent(e),r=(n||0)+(null!=t?t:1);this.query(e,r)},wake:t},F=z.make({Name:"tbone"});if(F.hasViewListener=o,F.priority=E,"undefined"!=typeof module)module.exports=F;else{var A=e.T,O=e.tbone;e.T=F,e.tbone=F,F.noConflict=function(){e.T=A,e.tbone=O}}var W=z.make({Name:"tbone_metrics"});F.metrics=W;var G={base:z};F.models=G;var V,I,P,J,Q={isScope:!0,trigger:function(){m(this)},execute:function(){var e=this;e.unbindAll(),e.destroySubScopes();var t=I;e.lookups=I={};var n=V;V=e,F.isExecuting=!0;try{e.fn()}finally{_.each(I,function(t){var n=t.obj,r=t.props;if(r[""])n.on("",e);else for(var i in r)n.on(i,e)}),e.onExecuteCb&&e.onExecuteCb(),I=t,V=n,F.isExecuting=!!V}},unbindAll:function(){var e=this;if(e.lookups){for(var t in e.lookups){var n=e.lookups[t],r=n.obj,i=n.props;for(var o in i)r.off(o,e)}e.lookups=null}},destroySubScopes:function(){var e=this;for(var t in e.subScopes)e.subScopes[t].destroy();e.subScopes=[]},destroy:function(){var e=this;e.parentScope=null,e.unbindAll(),e.destroySubScopes(),e.execute=t}},L=1,$=[],B={},H={};F.isReady=function(){return W.query("isReady")};var K;F.defer=function(e){var t=_.extend({priority:q,detached:!0,deferExec:!0},w(e)?{fn:e}:e);f(t)},F.drain=function(){J&&clearTimeout(J),b()},D=G.bound=z.extend({initialize:function(){var e=this;e.scope=f({fn:e.update,priority:e.priority,context:e,detached:!0,Name:e.Name&&"model_"+e.Name})},priority:k,wake:function(e){var t=this;t.scope&&(t.sleeping&&(t.sleeping=!1,t.reset()),_.each(t.scope.lookups,function(t){var n=t.obj;n&&!e[d(n)]&&(e[d(n)]=!0,n.wake(e))}))},onScopeExecute:function(e){},update:function(){var e=this;e.sleeping=e.sleepEnabled&&!o(e),e.sleeping||e._update()},_update:function(){var e=this.assumeChanged?{assumeChanged:!0}:U;this.query(e,M,this.state())},reset:function(){this.scope&&this.scope.trigger()},destroy:function(){var e=this;e.scope&&(e.scope.destroy(),e.scope=null),e.unset(M)},state:t,sleepEnabled:!1});var X=G.async=D.extend({_update:function(){var e=this,t=e.reqGeneration=(e.reqGeneration||0)+1,n=!1,r=e.state(function(r){return n=!0,t>=(e.updateGeneration||0)?(e.updateGeneration=t,e.abortCallback=null,e.query("",r),!0):void 0});n||(e.abortCallback=r&&r.onAbort)},abortPrevious:function(){this.abortCallback&&this.abortCallback()},priority:C}),Y=1,Z=z.extend({isCollection:!0,isModel:!0,model:z,add:function(e){function t(){if(null!=o&&(a.unset(o),a.trigger(o),delete a._removeCallbacks[o]),!u){var e=i.queryId();null==e&&(e="__unidentified"+Y++),e="#"+e,a.query(e,i),a.trigger(e),a._removeCallbacks[e]=n,o=e}}function n(){a.increment("size",-1),u=!0,t()}var i,o,a=this;r(e)?i=e:(i=a.model.make(),i.query("",e));var u;a.increment("size"),f(t)},remove:function(e){e="#"+(r(e)?e.queryId():e),this._removeCallbacks[e]&&this._removeCallbacks[e]()}}),ee=F.collections={base:Z};G.ajax=X.extend({state:function(e){function t(){v(n),n.onComplete()}var n=this,r=_.isString(n.url)?n.url:n.url();if(null==r)e(null);else{n.abortPrevious(),n.fetchedUrl=r,n.preFetch(),h(n);var i=function(t){e(n.parse(t))&&n.postFetch()};n.ajax({url:r,type:"GET",dataType:n.dataType,success:i,error:function(e){i(e&&e.responseText)},complete:t})}return{onAbort:function(){t()}}},parse:_.identity,ajax:function(){return x.ajax.apply(x,arguments)},preFetch:function(){this.unset()},postFetch:t,onComplete:t,sleepEnabled:!0,dataType:"json"});var te=e.localStorage;G.localStorage=z.extend({initialize:function(){var e,t=this;try{e=JSON.parse(te[t.key])}catch(e){}t.query("",e),f(function(){te[t.key]=JSON.stringify(t.query(""))})}}),G.location=z.extend({initialize:function(){function t(){var e=r("hash")!==location.hash||r("search")!==location.search||r("pathname")!==location.pathname;e&&(r("hash",location.hash),r("pathname",location.pathname),r("search",location.search),n=!0)}var n,r=this;x(e).bind("hashchange popstate pushstate replacestate",t),t(),f(function(){var e=r("pathname"),t=r("search"),i=r("hash");n||r.pushPath(e+(t||"")+(i?"#"+i:"")),n=!1})},pushPath:g("push"),replacePath:g("replace")}),ee.localStorage=Z.extend({initialize:function(){var e,t=this;try{e=JSON.parse(te[t.key])}catch(e){}_.each(e||[],function(e){t.add(e)}),f(function(){te[t.key]=JSON.stringify(t.query())})}});var ne=e.React;if(ne){var re=1,ie=2,oe=3,ae=ne.createClass;ne.createClass=function(e){function t(e,t,n){return f({fn:e,priority:F.priority.view,context:t,detached:!0,Name:"react_"+t.constructor.displayName+":"+n,isView:!0})}function n(e,t){var n=e.__tbone__[t];for(var r in n)n[r].destroy();e.__tbone__[t]=[]}function r(e){e.hasUpdateQueued||(e.__tbone__.hasUpdateQueued=1,n(e,"render"),e.isMounted()&&e.forceUpdate())}function i(i,o){return function(){var a=this,u=arguments;o===re&&(n(a,"render"),a.__tbone__.hasUpdateQueued=0);var s,c=o==ie,l=o===oe||c;if(i)if(c)a.__tbone__.mount.push(t(i.bind(a),a,"DidMount"));else{var f=!0,d=l?"DidUpdate":o?"WillUpdate":"Render";a.__tbone__.render.push(t(function(){f?(s=i.apply(a,u),f=!1):r(a)},a,d))}return l&&e.componentDidRender&&a.__tbone__.render.push(t(e.componentDidRender.bind(a),a,"DidRender")),s}}var o=_.extend({},e,{componentWillMount:function(){this.__tbone__={mount:[],render:[]};var t=e.componentWillMount;return t?t.apply(this,arguments):void 0},componentWillUnmount:function(){return n(this,"mount"),n(this,"render"),e.componentWillUnmount?e.componentWillUnmount.apply(this,arguments):void 0},componentWillUpdate:i(e.componentWillUpdate,re),componentDidUpdate:i(e.componentDidUpdate,oe),componentDidMount:i(e.componentDidMount,ie),render:i(e.render)});return ae(o)}}try{e.dispatchEvent(new e.CustomEvent("tbone_loaded"))}catch(e){}}(this);
});